---
title: "Pexlib Extraction Demo"
output: html_notebook
---

```{r Initialization, message=FALSE, warning=FALSE}
library(reticulate)
library(dplyr)
library(lubridate)
library(sparklyr)

source("src/helper.R")
source("src/extract_ianode.R")

pexlib <- import("pexlib")

req <- import("requests")
req$packages$urllib3$disable_warnings() 
rm(req)

```



```{r Multi-tags}
client = pexlib$Client(
  "https://casagszwebpi1.corp.riotinto.org/piwebapi/",
  "CORP\\crda.courtoisie",
  "#:3EmSY/4wKDfRBurD"                # Change me!
)
client$open()
sc <<- ConnectToSpark("reduction")

tryCatch({
  
  extraction_time_limit <- today()
  plants <- c("AAR", "ALM")
  
  lapply(plants, function(plant){
    
    plant_tags <- get_tags(plant)
    plant_max_ts <- get_max_ts_per_pot(sc, plant, plant_tags) %>%
      filter(max_ts < extraction_time_limit)
    extraction_intervals <- create_intervals(plant_tags, plant_max_ts, 1)
    extract_ianode(plant, extraction_intervals)
    
    # returns the earliest end time
    extraction_intervals %>%
      select(end_time) %>%
      summarize(end_time = min(end_time))
  }) %>%
    bind_rows() %>%
    summarize(end_time = min(end_time))
  
},
finally = {
  client$close()
  spark_disconnect(sc)
  spark_disconnect_all()
})

```





